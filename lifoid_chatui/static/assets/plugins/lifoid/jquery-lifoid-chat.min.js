!function(t){t.fn.lifoidchat=function(e){var a=null,n=function(t){"undefined"!=typeof console&&void 0!==console.error&&console.error("LifoidChat [ERROR]: "+t)},s=function(t){e.debug&&"undefined"!=typeof console&&void 0!==console.error&&console.debug("LifoidChat [DEBUG]: "+t)},l=function(t){if(!e.auth)return t({url:e.url,id:"me",username:"me",access_token:"access_token"});session=function(t){var e=new AWSCognito.CognitoIdentityServiceProvider.CognitoAuth(t);return e.userhandler={onSuccess:function(){s("session open")},onFailure:n},e.getSession(),e}(e.authData);return t({url:e.url,id:session.username,username:session.username,access_token:session.signInUserSession.accessToken.jwtToken})},o=function(t){return t.userId};new function(e,c){var d={debug:!1,data_from_session:l,userid_from_data:o};c="object"==typeof c?t.extend(d,c):d;var r=t('          <div class="panel panel-inverse">             <div class="panel-body" data-scrollbar="true" data-height="100%" style="padding-bottom:40px;">               <ul class="chats"></ul>             </div>           </div>'),m={},u=r.find(".chats").eq(0),p=function(){return u.children().last().prop("date")},f=function(){var t=new Date;return t.toISOString().substr(0,19)+"."+t.getUTCMilliseconds()},h=function(e,a){var n=this;return n.id=e,n.username=a,n.chat=function(e,a){new function(e,a,n,s,l){var o=this;if(o.$tpl="","message"==e){if(o.$tpl=t('              <li class="right">                 <a href="javascript:;" class="image"><img alt="" src="" /></a>                 <div class="message">                   <a href="javascript:;" class="name"></a>                   <span class="text"></span>                   <span class="date-time">11:23pm</span>                 </div>              </li>'),l){if(null!=s.attachments)for(i=0;i<s.attachments.length;i++){if(null!=s.attachments[i].file_url&&o.$tpl.append('<a href="'+s.attachments[i].file_url+'" target="_blank" class="btn btn-info m-t-5" style="margin-left:70px;">'+s.attachments[i].text+"</a>"),null!=s.attachments[i].actions)if("menu_select"==s.attachments[i].actions[0].name)for(j=0;j<s.attachments[i].actions.length;j++)for(o.$tpl.append('<form class="form-input-flat m-t-5"></form>'),o.$tpl.find(".form-input-flat").append('<div class="form-group row" style="margin-left:70px;"><select class="form-control col-sm-4 lifoid-ms"><option value="">Please select an option</option></select></div>'),k=0;k<s.attachments[i].actions[j].options.length;k++)o.$tpl.find(".form-control").append('<option value="'+s.attachments[i].actions[j].options[k].value+'">'+s.attachments[i].actions[j].options[k].text+"</option>");else for(o.$tpl.append('<div class="btn-group m-t-5" style="margin-left:70px;"></div>'),j=0;j<s.attachments[i].actions.length;j++)o.$tpl.find(".btn-group").append('<button type="button" class="btn btn-info lifoid-qr" data-value="'+s.attachments[i].actions[j].value+'">'+s.attachments[i].actions[j].name+"</button>");if(null!=s.attachments[i].table){for(o.$attachment=t('                      <div class="panel panel-info m-t-5">                        <div class="panel-heading">                        <h4 class="panel-title">'+s.attachments[i].table.title+'</h4>                        </div>                        <div class="table-responsive">                          <table class="table table-striped lifoid-edit-table" data-name="'+s.attachments[i].table.name+'" data-columns="'+s.attachments[i].table.columns.join()+'" data-types="'+s.attachments[i].table.types.join()+"\" data-rows='"+JSON.stringify(s.attachments[i].table.rows)+"' data-title=\""+s.attachments[i].table.title+'" style="margin-bottom:4px;">                            <thead><tr class="info"><th></th></tr></thead>                            <tbody>                            </tbody>                          </table>                        </div>                      </div>                      '),j=0;j<s.attachments[i].table.columns.length;j++)o.$attachment.find("thead > tr").append('<th class="text-center">'+s.attachments[i].table.columns[j]+"</th>");for(j=0;j<s.attachments[i].table.rows.length;j++)for(o.$attachment.find("tbody").append('<tr><td class="text-center"><button class="btn btn-xs btn-danger" type="button"><i class="fa fa-minus"></i></button></td></tr>'),k=0;k<s.attachments[i].table.columns.length;k++)column=s.attachments[i].table.columns[k],"Date"==s.attachments[i].table.types[k]?o.$attachment.find("tbody > tr:last").append('                          <td data-value="'+moment().format("MM/DD/YYYY")+'">                          <input class="daterange-singledate form-control" type="text" name="'+column+'" value="'+moment().format("MM/DD/YYYY")+'" />                          </td>                          '):o.$attachment.find("tbody > tr:last").append("<td>"+s.attachments[i].table.rows[j][column]+"</td>");o.$attachment_btn=t('                      <div class="btn-group m-t-5">                        <button class="btn btn-info add-row btn-sm" type="button"><i class="fa fa-plus"></i></button>                        <button class="btn btn-info send-table btn-sm" type="button"><i class="fa fa-send"></i></button>                      </div>                      '),o.$tpl.append(o.$attachment),o.$tpl.append(o.$attachment_btn),o.$tpl.find("table").editableTableWidget({editor:t('<input class="table-input">')}),o.$tpl.find(".daterange-singledate").each(function(){var e=this;t(this).daterangepicker({start:moment(),singleDatePicker:!0,showDropdowns:!0,drops:"up",locale:{format:"MM/DD/YYYY"}},function(a,n,i){selected_date=a.format("MM/DD/YYYY"),e.value=selected_date,t(e.parentNode).attr("data-value",selected_date)})}),o.$tpl.on("click",".btn-danger",function(){this.parentNode.parentNode.remove()}),o.$tpl.on("click",".add-row",function(){var e=u.find(".lifoid-edit-table"),a=e.attr("data-types").split(","),n=e.attr("data-columns").split(","),i=JSON.parse(e.attr("data-rows"));for(e.find("tbody").append('<tr><td class="text-center"><button class="btn btn-xs btn-danger" type="button"><i class="fa fa-minus"></i></button></td></tr>'),k=0;k<a.length;k++)column=n[k],"Date"==a[k]?e.find("tbody > tr:last").append('                          <td data-value="'+moment().format("MM/DD/YYYY")+'">                          <input class="daterange-singledate form-control" type="text" name="'+column+'" value="'+moment().format("MM/DD/YYYY")+'" />                          </td>                          '):e.find("tbody > tr:last").append("<td>"+i[0][column]+"</td>");e.editableTableWidget({editor:t('<input class="table-input">')}),e.find(".daterange-singledate").each(function(){var e=this;t(this).daterangepicker({start:moment(),singleDatePicker:!0,showDropdowns:!0,drops:"up",locale:{format:"MM/DD/YYYY"}},function(a,n,i){selected_date=a.format("MM/DD/YYYY"),e.value=selected_date,t(e.parentNode).attr("data-value",selected_date)})})})}}o.$tpl.addClass("left").removeClass("right"),o.$tpl.find("img").attr("src",c.lifoidAvatar)}else if(o.$tpl.find("img").attr("letters","Me"),null!=s.attachments)for(i=0;i<s.attachments.length;i++)if(null!=s.attachments[i].table){for(o.$attachment=t('                    <div class="panel panel-info m-t-5">                      <div class="panel-heading">                      <h4 class="panel-title">'+s.attachments[i].table.title+'</h4>                      </div>                      <div class="table-responsive">                        <table class="table table-striped">                          <thead><tr class="info"></tr></thead>                          <tbody></tbody>                        </table>                      </div>                    </div>                      '),j=0;j<s.attachments[i].table.columns.length;j++)o.$attachment.find("thead > tr").append('<th class="text-center">'+s.attachments[i].table.columns[j]+"</th>");for(j=0;j<s.attachments[i].table.rows.length;j++)for(o.$attachment.find("tbody").append("<tr></tr>"),k=0;k<s.attachments[i].table.columns.length;k++)column=s.attachments[i].table.columns[k],o.$attachment.find("tbody > tr:last").append("<td>"+s.attachments[i].table.rows[j][column]+"</td>");o.$tpl.append(o.$attachment)}o.$tpl.find(".name").text(a).html(),o.$tpl.find(".text").text(s.text).html(),o.$tpl.find(".date-time").text(prettyDate(n)).html(),o.$tpl.prop("date",n)}u.append(o.$tpl),generateAvatars()}("message",n.username,a,e,n.id==c.lifoidId)},n};c.data_from_session(function(i){m[i.id]=new h(i.id,i.username),m[c.lifoidId]=new h(c.lifoidId,c.lifoidName),a=new function(e){var a=this;return a.url=e.url,a.access_token=e.access_token,a.username=e.username,a.load=function(e,n,i){t.ajax({type:"POST",url:a.url+"/messages",data:JSON.stringify({access_token:a.access_token,to_date:e,user:{username:a.username}}),contentType:"application/json",dataType:"json"}).done(function(t){n(t)}).fail(function(t,e){403==t.status&&(console.log(c.expiredUrl),window.location.href=c.expiredUrl),i("Cannot fetch Lifoid server")})},a.subscribe=function(e,n,i){setTimeout(function(){t.ajax({type:"POST",url:a.url+"/messages",data:JSON.stringify({access_token:a.access_token,from_date:e,user:{username:a.username}}),contentType:"application/json",dataType:"json"}).done(function(t){t.length>0?n(t):a.subscribe(e,n,i)}).fail(function(t,e){403==t.status&&(window.location.href=c.expiredUrl),i("Cannot fetch Lifoid server")})},500)},a.publish=function(e,n,i){t.ajax({type:"POST",url:a.url+"/webhook",data:JSON.stringify(e),contentType:"application/json"}).done(function(t){var e=t;a.subscribe(e,n,i)}).fail(function(t,s){403==t.status&&(window.location.href=c.expiredUrl),i("Cannot fetch Lifoid server"),setTimeout(function(){a.publish(e,n,i)},1e4)})},a}(i);var l=f();s("fetch:"+l);var o=function(e,i,s,l){var o=f();m[i.id].chat({text:s,attachments:l},o),t("html, body").animate({scrollTop:t(document).height()},100),a.publish({q:{text:s,attachments:l},access_token:i.access_token,user:{username:i.username}},function(e){for(var a=0;a<e.length;a++)m[e[a].from_user].chat(e[a].payload,e[a].date);t("html, body").animate({scrollTop:t(document).height()},100)},n)};document.getElementById("quickStart").addEventListener("click",function(){o(0,i,t(this).html())}),document.getElementById("help").addEventListener("click",function(){o(0,i,t(this).html())}),document.getElementById("english").addEventListener("click",function(){o(0,i,t(this).html())}),document.getElementById("japanese").addEventListener("click",function(){o(0,i,t(this).html())}),u.on("click",".lifoid-qr",function(){valueSelected=t(this).attr("data-value"),this.parentNode.remove(),o(0,i,valueSelected)}),u.on("change",".lifoid-ms",function(){t("option:selected",this);var e=this.value;t(".lifoid-ms").remove(),o(0,i,e)}),u.on("click",".send-table",function(){var t=u.find(".lifoid-edit-table"),e=t.tableToJSON({ignoreColumns:[0],textDataOverride:"data-value"});o(0,i,t.attr("data-title"),[{table:{title:t.attr("data-title"),name:t.attr("data-name"),rows:e,columns:t.attr("data-columns").split(",")}}]),u.find(".panel").remove(),t.remove(),this.parentNode.remove()}),u.on("validate","table td",function(e,a){var n=t(this).index();return"Numeric"===u.find(".lifoid-edit-table").attr("data-types").split(",")[n-1]?!isNaN(parseFloat(a))&&isFinite(a):!!a&&a.trim().length>0}),e.empty().append(r),t("#"+c.textFormId).submit(function(){var e=t('input[type="text"]');return e.val()&&(o(0,i,e.val()),e.val(""),t(".lifoid-ms").remove(),t(".lifoid-qr").remove()),!1}),a.load(l,function(e){0==e.length&&(welcome_now=f(),m[c.lifoidId].chat({text:c.welcomeMsg,attachments:[{actions:[{name:"English",style:"default",text:"English",type:"button",value:"Speak English"},{name:"日本語",style:"default",text:"日本語",type:"button",value:"日本語でチャットをする"}]}]},welcome_now));for(var a=e.length-1;a>=0;a--)if(!(void 0!=p()&&e[a].date<=p())){if(null!=e[a].payload.attachments)for(j=0;j<e[a].payload.attachments.length;j++)"table"in e[a].payload.attachments[j]&&e[a].from_user!=c.lifoidId||e[a].payload.attachments.splice(j,1);m[e[a].from_user].chat(e[a].payload,e[a].date)}t("html, body").animate({scrollTop:t(document).height()},100)},n)})}(this,e);return this}}(jQuery);